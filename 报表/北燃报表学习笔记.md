# 数据库：SQL Server 2019


# 1.相关节点：
## 收回报表权限（删除报表权限）：
按应用查角色节点，左上角输入报表的名字
依次点进角色编码
在已分配职责里找，N415，箭头移到左边
（职责和角色编码都可以）

## 职责和角色：
职责：报表就是一个职责
角色：在某个公司的某个用户有某个职责

## 手册：
报表节点-学习手册20250825v1.0

## 节点名称：
分析模型-全局，生产技能人员结构报表
报表设计-全局
模板设置-集团，点击修改，选中子集查表名

## 写报表：
（1）确定在前台怎么搜索，要查询哪些字段，有哪些筛选条件
（2）确定对应的表
（3）怎样查看表里的值

## 改报表：
（1）导出旧报表到测试环境
（2）确定查询条件，找出有问题的数据
（3）打印并分析



# 2.京内子公司人数统计缺失：

## 关键差异分析

### 1. 去重逻辑的差异

**原版 (MZ702原版.sql)**：
```sql
select distinct bd_psndoc.pk_psndoc,
-- ... 其他字段
from (select distinct bd_psndoc.pk_psndoc, ...)
```

**修改版 (MZ702人员年龄、技能等级、学历报表.sql)**：
```sql
select bd_psndoc.pk_psndoc,
-- ... 其他字段
,ROW_NUMBER() OVER (PARTITION BY bd_psndoc.pk_psndoc ORDER BY T1.begindate DESC) as rn
from (select bd_psndoc.pk_psndoc, ...)
-- 然后在最外层添加
where rn = 1
```

### 2. 计数方式的差异

**原版**：
```sql
,count(hz) hz,count(bshz) bshz
,count(nan) nan ,count(nv) nv
```

**修改版**：
```sql
,count(distinct case when hz = 1 then pk_psndoc end) hz,count(distinct case when bshz = 1 then pk_psndoc end) bshz
,count(distinct case when nan = 1 then pk_psndoc end) nan ,count(distinct case when nv = 1 then pk_psndoc end) nv
```

## 根本原因

**原版的问题**：
- 原版在子查询中使用了 `select distinct bd_psndoc.pk_psndoc`
- 如果同一个人员有多条记录，`distinct` 可能会随机选择一条，而不是按时间排序选择最新的
- 这可能导致选择了错误的工作记录（比如选择了已结束的工作记录）

**修改版的改进**：
- 修改版使用 `ORDER BY T1.begindate DESC` 确保选择最新的工作记录
- 通过 `where rn = 1` 确保每个人员只取一条记录，但这条记录是最新的

## 具体场景示例

可能存在一个人员：
- 在指定时间范围内有两条工作记录
- 第一条记录：`begindate` 较早，组织类型不是"京内子公司"
- 第二条记录：`begindate` 较晚，组织类型是"京内子公司"
- 原版的 `distinct` 可能随机选择了第一条记录，导致该人员被错误分类
- 修改版的 `ROW_NUMBER()` 会正确选择第二条记录，将该人员正确归类为"京内子公司"

## 结论

原版比修改版少一个的原因是原版使用的 `distinct` 去重方法不够精确，可能随机选择了不是最新的工作记录，导致某个应该归类为"京内子公司"的人员被错误分类。修改版通过使用 `ROW_NUMBER()` 按时间排序选择最新记录，确保了数据统计的准确性，因此多统计了一个人员。



# 3.全集团燃气具安装维修工高级技师人员姓名查询
```sql
-- 全集团燃气具安装维修工高级技师人员姓名查询
select 
bd_psndoc.name as psn_name
,bd_psndoc.code as psn_code
,T2.name as org_name
,org_dept.name as dept_name
from bd_psndoc bd_psndoc 
inner join hi_psnorg hi_psnorg 
on hi_psnorg.pk_psndoc = bd_psndoc.pk_psndoc 
left outer join hi_psnjob T1 
ON T1.pk_psndoc = bd_psndoc.pk_psndoc 
left outer join org_adminorg T2 
ON T2.pk_adminorg = T1.pk_org 
left outer join hi_psndoc_glbdef2 T3 
ON T3.pk_psndoc = bd_psndoc.pk_psndoc 
left outer join org_dept org_dept 
on org_dept.pk_dept = T1.pk_dept 
left outer join hi_entryapply hi_entryapply 
on hi_entryapply.pk_psnjob = T1.pk_psnjob 
left outer join bd_psncl  --人员类别
on T1.pk_psncl=bd_psncl.pk_psncl
where 1 = 1 and ( hi_psnorg.indocflag = 'Y' and hi_psnorg.psntype = 0 ) 
and T1.endflag='N' and T1.lastflag='Y' and T1.ismainjob='Y'  and T1.trnsevent <> '4'
and T3.glbdef7.name='已聘任该项技能等级'--是否聘任专业技术职务为'已聘任该项专业技术职务'
and T1.begindate<=datefmt(parameter('param2'),'yyyy-mm-dd') and nvl(T1.enddate, '2099-12-31') >= datefmt(parameter('param2'),'yyyy-mm-dd')
and bd_psncl.name in (parameter('rylb'))
and t2.name in (parameter('zzmc'))
and T3.glbdef1.name = '高级技师（一级）'  -- 筛选高级技师
and T3.glbdef3 = '燃气具安装维修工'  -- 筛选燃气具安装维修工
order by T2.name, org_dept.name, bd_psndoc.name
```


已知身份证号，查其他信息
```sql
select 
    t1.code ry_code,                         
    t1.name ry_name,                         
    t1.id ry_idcard,                         
    t2.name current_org,                     
    t3.name current_dept,                    
    t1.mobile ry_mobile,                     
    t1.age ry_age                             
from bd_psndoc t1                            
    inner join hi_psnorg t1_org              
        on t1_org.pk_psndoc = t1.pk_psndoc 
        and t1_org.indocflag = 'Y'           
    left join hi_psnjob t6                   
        on t6.pk_psndoc = t1.pk_psndoc
        and t6.enddate is null               
    left join org_orgs t2                   
        on t2.pk_org = t6.pk_org
    left join org_dept t3                    
        on t3.pk_dept = t6.pk_dept
where t1.id = '110226198909030022'
```