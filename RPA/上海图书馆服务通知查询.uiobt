Try

Dim hWeb,arrayData,arrElement,arrRet,objExcelWorkBook,strOriginal,arrParts,item,strDate,keywords,pattern,titleRow,dateStr,dateMatch,timeStr,pureDate
hWeb = WebBrowser.Create("edge","https://www.library.sh.cn/",30000,{"bContinueOnError":false,"iDelayAfter":300,"iDelayBefore":200,"sBrowserPath":"","sStartArgs":""})

Mouse.Hover(@ui"链接<a>_动态1",10000,{"bContinueOnError": false, "iDelayAfter": 300, "iDelayBefore": 200, "bSetForeground": true, "sCursorPosition": "Center", "iCursorOffsetX": 10, "iCursorOffsetY": 10, "sKeyModifiers": [],"sSimulate": "simulate", "bMoveSmoothly": false})
Mouse.Action(@ui"文本<span>_新闻公告2","left","click",10000,{"bContinueOnError": false, "iDelayAfter": 300, "iDelayBefore": 200, "bSetForeground": true, "sCursorPosition": "Center", "iCursorOffsetX": 0, "iCursorOffsetY": 0, "sKeyModifiers": [],"sSimulate": "simulate", "bMoveSmoothly": false})
Delay(1000)
Rem 获取标题

arrayData = UiElement.DataScrap({"wnd":[{"cls":"Chrome_WidgetWin_1","title":"*","app":"msedge"}],"html":[{"tag":"DIV","parentid":"news","css-selector":"body>div>div>div>div>main>div>div>div>div>div>div>div>div>div>div>div"}]},{"ExtractTable":0,"Columns":[{"selecors":{"path":[{"tag":"span"},{"tag":"a","idx":0}],"exact":true,"vprops":["text","url"]},"props":["url"]}]},{"objNextLinkElement":'',"iMaxNumberOfPage":5,"iMaxNumberOfResult":-1,"iDelayBetweenMS":1000,"bContinueOnError":False})
Mouse.Action(@ui"标题<h1>_新闻公告","left","click",10000,{"bContinueOnError": false, "iDelayAfter": 300, "iDelayBefore": 200, "bSetForeground": true, "sCursorPosition": "Center", "iCursorOffsetX": 0, "iCursorOffsetY": 0, "sKeyModifiers": [],"sSimulate": "simulate", "bMoveSmoothly": false})
Rem 获取日期
arrayDate = UiElement.DataScrap({"wnd":[{"cls":"Chrome_WidgetWin_1","title":"*","app":"msedge"},{"cls":"Chrome_RenderWidgetHostHWND","title":"Chrome Legacy Window"}],"html":[{"tag":"DIV","id":"app"}]},{
    "ExtractTable": 0,
    "Columns": [
           {
            "selecors": [
                {
                    "tag": "div",
                    "index": 0,
                    "className": "container subPage-main",
                    "value": "div.container.subPage-main",
                    "prefix": ""
                },
                {
                    "tag": "div",
                    "index": 0,
                    "className": "subPage-body",
                    "value": "div.subPage-body",
                    "prefix": ">"
                },
                {
                    "tag": "div",
                    "index": 0,
                    "className": "row",
                    "value": "div.row",
                    "prefix": ">"
                },
                {
                    "tag": "div",
                    "index": 0,
                    "className": "col",
                    "value": "div.col",
                    "prefix": ">"
                },
                {
                    "tag": "div",
                    "index": 0,
                    "className": "",
                    "value": "div",
                    "prefix": ">"
                },
                {
                    "tag": "div",
                    "index": 0,
                    "className": "news-list",
                    "value": "div.news-list",
                    "prefix": ">"
                },
                {
                    "tag": "div",
                    "index": 0,
                    "className": "news-list",
                    "value": "div.news-list",
                    "prefix": ">"
                },
                {
                    "tag": "span",
                    "value": "span",
                    "index": 0,
                    "prefix": ">"
                },
                {
                    "tag": "a",
                    "index": 0,
                    "className": "u-id-act-ta-it",
                    "value": "a.u-id-act-ta-it",
                    "prefix": ">"
                },
                {
                    "tag": "div",
                    "index": 0,
                    "className": "u-id-act-ta-it-date",
                    "value": "div.u-id-act-ta-it-date",
                    "prefix": ">"
                }
            ],
            "props": ["text"]
        }
    ]
},{"objNextLinkElement":"","iMaxNumberOfPage":2,"iMaxNumberOfResult":-1,"iDelayBetweenMS":1000,"bContinueOnError":False})

Rem 获取链接
arrayHref = UiElement.DataScrap({"wnd":[{"cls":"Chrome_WidgetWin_1","title":"*","app":"msedge"},{"cls":"Chrome_RenderWidgetHostHWND","title":"Chrome Legacy Window"}],"html":[{"tag":"DIV","id":"app"}]},{
    "ExtractTable": 0,
    "Columns": [
        {
            "selecors": [
                {
                    "tag": "div",
                    "index": 0,
                    "className": "container subPage-main",
                    "value": "div.container.subPage-main",
                    "prefix": ""
                },
                {
                    "tag": "div",
                    "index": 0,
                    "className": "subPage-body",
                    "value": "div.subPage-body",
                    "prefix": ">"
                },
                {
                    "tag": "div",
                    "index": 0,
                    "className": "row",
                    "value": "div.row",
                    "prefix": ">"
                },
                {
                    "tag": "div",
                    "index": 0,
                    "className": "col",
                    "value": "div.col",
                    "prefix": ">"
                },
                {
                    "tag": "div",
                    "index": 0,
                    "className": "",
                    "value": "div",
                    "prefix": ">"
                },
                {
                    "tag": "div",
                    "index": 0,
                    "className": "news-list",
                    "value": "div.news-list",
                    "prefix": ">"
                },
                {
                    "tag": "div",
                    "index": 0,
                    "className": "news-list",
                    "value": "div.news-list",
                    "prefix": ">"
                },
                {
                    "tag": "span",
                    "value": "span",
                    "index": 0,
                    "prefix": ">"
                },
                {
                    "tag": "a",
                    "index": 0,
                    "className": "u-id-act-ta-it",
                    "value": "a.u-id-act-ta-it",
                    "prefix": ">"
                }
            ],
            "props": ["href"]
        }
    ]
},{"objNextLinkElement":"","iMaxNumberOfPage":2,"iMaxNumberOfResult":-1,"iDelayBetweenMS":1000,"bContinueOnError":False})

Rem 合并数组
resultArray = []
For i = 0 To UBound(arrayTitle) - 1
    newItem = [
        arrayTitle[i][0],  
        arrayHref[i][0],   
        arrayDate[i][0]   
    ]
    push(resultArray, newItem)
Next
TracePrint(resultArray)

Rem 使用Python插件处理数据
resultArray1 = library_data_processor.filter_library_data(resultArray)
TracePrint(resultArray1)

Rem 使用Python插件按日期过滤数据（7天前到昨天）
resultArray2 = library_data_processor.filter_by_date_range(resultArray1, 7)
TracePrint(resultArray2) 

Rem 使用Python插件添加图书馆名称
resultArray2 = library_data_processor.add_library_name(resultArray2, "上海图书馆")
TracePrint(resultArray2)

Rem 写入Excel
// 重新计算日期用于文件名
currentDate = Time.Date()  
yesterday = Time.DateAdd("d", -1, currentDate)  
sevenDaysAgo = Time.DateAdd("d", -7, currentDate)  
sYesterday1 = Time.Format(yesterday, "yyyymmdd")  
sSevenDaysAgo1 = Time.Format(sevenDaysAgo, "yyyymmdd")  
sRet = "("+sSevenDaysAgo1+"-"+sYesterday1+")"
filePath = '''D:\Desktop\图书馆\服务通知查询\服务通知'''+sRet+'''.xlsx'''
objExcelWorkBook = Excel.OpenExcel(filePath, true, "Excel", "", "")

titleCheck = Excel.ReadCell(objExcelWorkBook, "Sheet1", "A1")
If titleCheck = "" 
    titleRow = [["图书馆名称", "标题","网页链接", "发布时间", "关键信息"]]
    Excel.WriteRow(objExcelWorkBook, "Sheet1", "A1", titleRow, false)
    startRow = 2 
Else
    iRowCount = Excel.GetRowsCount(objExcelWorkBook, "Sheet1")
    startRow = iRowCount + 1  
End If

Delay(1000)
If UBound(resultArray2) >= 0 And Len(resultArray2) > 0 
    startCell = "A" & CStr(startRow)
    Excel.WriteRange(objExcelWorkBook, "Sheet1", startCell, resultArray2, false)
    TracePrint("数据已追加到Excel文件，从" & startCell & "开始")
Else
    TracePrint("没有找到匹配的数据，未写入内容")
End If

Excel.SetColumnWidth(objExcelWorkBook,"Sheet1","A1",20,false)
Excel.SetColumnWidth(objExcelWorkBook,"Sheet1","B1",80,false)
Excel.SetColumnWidth(objExcelWorkBook,"Sheet1","C1",70,false)
Excel.SetColumnWidth(objExcelWorkBook,"Sheet1","D1",10,false)
Excel.SetColumnWidth(objExcelWorkBook,"Sheet1","E1",30,false)
Excel.Save(objExcelWorkBook)
Excel.CloseExcel(objExcelWorkBook,true)

Rem 依次点击符合条件的标题
// 测试数据
// resultArray2 = [
//     [
//         "上海图书馆",
//         "发展规划建言献策",
//         "https://www.nlc.cn/web/dsb_zx/zxgg/20250731_2647288.shtml",
//         "2025/07/23",
//         "guanjianxinxi"

//     ],
//     [
//         "上海图书馆",
//         "2025年公开招聘辅助人员",
//         "https://example.com/1",
//         "2025-08-05",
//         "guanjianxinxi"

//     ],
//     [
//         "上海图书馆",
//         "测试记录2",
//         "https://example.com/2",
//         "2025/8/7",
//         "guanjianxinxi"

//     ],
//     [
//         "上海图书馆",
//         "测试记录3",
//         "https://example.com/3",
//         "2024-09-05",
//         "guanjianxinxi"

//     ],
//     [
//         "上海图书馆",
//         "匹配记录1",
//         "https://example.com/4",
//         "2025-08-06",
//         "guanjianxinxi"

//     ]
// ]

TracePrint(resultArray2)
arrTitle = []
For Each subArray In resultArray2
    Push(arrTitle, subArray[3])
Next
TracePrint(arrTitle)
For Each title In arrTitle
    Delay(1000)
    TracePrint(title)
    
    Text.Click(@ui"块级元素<div>_上海图书馆、市社联与市方志办开展深入贯彻中央八项规定精神学习教育党委（党组）理论3",title,"regex",1,"left","click",10000,{"bContinueOnError":false,"iDelayAfter":300,"iDelayBefore":200,"bSetForeground":true,"sCursorPosition":"Center","iCursorOffsetX":0,"iCursorOffsetY":0,"sKeyModifiers":[],"sSimulate":"simulate"})
    sRet = Text.Get(@ui"块级元素<div>_上海图书馆徐家汇藏书楼暂停开放公告2025-07-2300:00尊敬的读者：上海",10000,{"bContinueOnError":false,"iDelayAfter":300,"iDelayBefore":200,"bSetForeground":true})
    TracePrint($PrevResult)

    Rem 输出到deepseek
    result = test.handle_uibot_string(sRet)
    TracePrint(result)

    Rem 遍历字典处理deepseek返回的内容
    // 测试数据
    // result={"服务人群" : ["读者"],"服务类型" : ["图书馆服务","规划研究"],"服务范围" : ["上海"]}

    // 初始化目标数组
    arrType = []
    arrAddress = []
    arrPeople = []

// 遍历字典，按key匹配赋值
For Each key, value In result
    Select Case key
       Case "服务类型"
            arrType = value    // 赋值给服务类型数组
       Case "服务范围"
            arrAddress = value // 赋值给服务范围数组
       Case "服务人群"
            arrPeople = value  // 赋值给服务人群数组
    End Select
Next

Rem 写入到excel
objExcelWorkBook = Excel.OpenExcel('''D:\Desktop\关键词库.xlsx''',true,"Excel","","")

// 写入标题
titleCheck = Excel.ReadCell(objExcelWorkBook, "Sheet1", "A1")
If titleCheck = "" 
    titleRow = [["服务类型", "服务范围","服务人群"]]
    Excel.WriteRow(objExcelWorkBook, "Sheet1", "A1", titleRow, false)
    startRow = 2 
End If

// 写入服务类型
isExit = false
dLastRow = 1

Do While isExit = false
    currentValue = Excel.ReadCell(objExcelWorkBook, "Sheet1", "A" & CStr(dLastRow), true)
    If currentValue = "" 
        isExit = true  
    Else
        dLastRow = dLastRow + 1  
    End If
Loop

dStartRow = dLastRow

Delay(1000)

If UBound(arrType) >= 0 
    dStartCell = "A" & CStr(dStartRow)
    Excel.WriteColumn(objExcelWorkBook, "Sheet1", dStartCell, arrType, false)
Else
    TracePrint("arrType数组中没有数据，未写入内容")
End If

// 写入服务范围
isExit = false
dLastRow = 1

Do While isExit = false
    currentValue = Excel.ReadCell(objExcelWorkBook, "Sheet1", "B" & CStr(dLastRow), true)
    If currentValue = "" 
        isExit = true  
    Else
        dLastRow = dLastRow + 1  
    End If
Loop

dStartRow = dLastRow

Delay(1000)

If UBound(arrAddress) >= 0 
    dStartCell = "B" & CStr(dStartRow)
    Excel.WriteColumn(objExcelWorkBook, "Sheet1", dStartCell, arrAddress, false)
Else
    TracePrint("arrAddress数组中没有数据，未写入内容")
End If

// 写入服务人群
isExit = false
dLastRow = 1

Do While isExit = false
    currentValue = Excel.ReadCell(objExcelWorkBook, "Sheet1", "C" & CStr(dLastRow), true)
    If currentValue = "" 
        isExit = true  
    Else
        dLastRow = dLastRow + 1  
    End If
Loop

dStartRow = dLastRow

Delay(1000)

If UBound(arrPeople) >= 0 
    dStartCell = "C" & CStr(dStartRow)
    Excel.WriteColumn(objExcelWorkBook, "Sheet1", dStartCell, arrPeople, false)
Else
    TracePrint("arrPeople数组中没有数据，未写入内容")
End If

// 保存到Excel
Excel.Save(objExcelWorkBook)
Excel.CloseExcel(objExcelWorkBook,true)

Mouse.Action(@ui"链接<a>_公告","left","click",10000,{"bContinueOnError": false, "iDelayAfter": 300, "iDelayBefore": 200, "bSetForeground": true, "sCursorPosition": "Center", "iCursorOffsetX": 0, "iCursorOffsetY": 0, "sKeyModifiers": [],"sSimulate": "simulate", "bMoveSmoothly": false})


Next

Catch 异常
TracePrint(异常)
END Try





