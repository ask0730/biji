Dim data
Try
Dim iRet,hWeb,arrElement,sRet,arrayData

Rem 检查标志位
Dim flagFilePath, alreadyDownloaded, currentYear
currentYear = CStr(Time.Format(Time.Date(), "yyyy"))
flagFilePath = "C:\\Users\\Administrator\\Desktop\\年报下载标志位\\国家图书馆_download_flag_" & currentYear & ".txt"

alreadyDownloaded = False
If File.FileExists(flagFilePath) Then
    alreadyDownloaded = True
    TracePrint("国家图书馆" & currentYear & "年年报已下载，跳过下载流程")
End If

If alreadyDownloaded Then
    TracePrint("国家图书馆年报下载流程已执行，程序结束")
    exit
End If

 Dim folderPath
    folderPath = "C:\\Users\\Administrator\\Desktop\\图书馆\\年报下载"
    If Not File.FolderExists(folderPath)
        File.CreateFolder(folderPath)
    End If

hWeb = WebBrowser.Create("innerbrowser","https://www.nlc.cn/",30000,{"bContinueOnError":false,"iDelayAfter":300,"iDelayBefore":200,"sBrowserPath":"","sStartArgs":""})
Mouse.Action(@ui"链接<a>_信息公开1","left","click",10000,{"bContinueOnError": false, "iDelayAfter": 300, "iDelayBefore": 200, "bSetForeground": true, "sCursorPosition": "Center", "iCursorOffsetX": 0, "iCursorOffsetY": 0, "sKeyModifiers": [],"sSimulate": "simulate", "bMoveSmoothly": false})

Rem 获取去年
dTime = Time.Date()
currentYear = CInt(Time.Format(dTime, "yyyy"))
lastYear = currentYear - 1
sLastYear = CStr(lastYear)
sName=sLastYear+"年度部门决算"

Rem 点击对应的年报
Text.Click(@ui"块级元素<div>_·国家图书馆2024年度部门决算·国家图书馆2025年度部门预算·2022年国家1",sName,"instr",1,"left","click",10000,{"bContinueOnError":false,"iDelayAfter":300,"iDelayBefore":200,"bSetForeground":true,"sCursorPosition":"Center","iCursorOffsetX":0,"iCursorOffsetY":0,"sKeyModifiers":[],"sSimulate":"simulate"})

Mouse.Action(@ui"分组","left","click",10000,{"bContinueOnError": false, "iDelayAfter": 300, "iDelayBefore": 200, "bSetForeground": true, "sCursorPosition": "Center", "iCursorOffsetX": 0, "iCursorOffsetY": 0, "sKeyModifiers": [],"sSimulate": "simulate", "bMoveSmoothly": false})


Keyboard.InputText(@ui"窗口_地址:下载1","C:\\Users\\Administrator\\Desktop\\图书馆\\年报下载",true,300,10000,{"bContinueOnError": false, "iDelayAfter": 300, "iDelayBefore": 500, "bSetForeground": true, "sSimulate": "simulate", "bValidate": false, "bClickBeforeInput": true})
Mouse.Action(@ui"窗口_ad77d431(2)","left","dbclick",10000,{"bContinueOnError": false, "iDelayAfter": 300, "iDelayBefore": 200, "bSetForeground": true, "sCursorPosition": "Center", "iCursorOffsetX": 0, "iCursorOffsetY": 0, "sKeyModifiers": [],"sSimulate": "simulate", "bMoveSmoothly": false})
sRet=sLastYear+"年国家图书馆年报"
Keyboard.InputText(@ui"窗口_ad77d431",sRet,true,300,10000,{"bContinueOnError": false, "iDelayAfter": 300, "iDelayBefore": 500, "bSetForeground": true, "sSimulate": "message", "bValidate": false, "bClickBeforeInput": false})
Mouse.Action(@ui"窗口_保存(S)","left","click",10000,{"bContinueOnError": false, "iDelayAfter": 300, "iDelayBefore": 200, "bSetForeground": true, "sCursorPosition": "Center", "iCursorOffsetX": 0, "iCursorOffsetY": 0, "sKeyModifiers": [],"sSimulate": "simulate", "bMoveSmoothly": false})

Rem 设置标志位
Dim flagContent
flagContent = "年报下载完成时间: " & Time.Format(Time.Date(), "yyyy-mm-dd hh:mm:ss") & vbCrLf & "下载年份: " & currentYear
File.RenameEx(flagFilePath,flagContent)
TracePrint("国家图书馆" & currentYear & "年年报下载完成，已设置标志位")

Catch 异常
TracePrint(异常)
END Try