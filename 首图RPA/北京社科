
Dim a,b,folderPath,fileName,lastName,wordname,currentElement,sRet1,dRet,arr日期,arr月日,arr邮箱
Try
Dim iRet,hWeb,arrElement,sRet,objWord,objRect,objJSON,bRet,arrayRet,jsonRet,sText,arrayData,arrRet,正文i,style,arrWordFiles
hWeb = WebBrowser.Create("edge","https://www.bjsk.org.cn/newslist-1486-0-0.html",30000,{"bContinueOnError":false,"iDelayAfter":300,"iDelayBefore":200,"sBrowserPath":"","sStartArgs":""})

arrElement = UiElement.GetChildren(@ui"块级元素<div>_通知公告“深入学习贯彻党的二十届四中全会精神”专栏征文启事为深入学习贯彻党的二十",4, {"bContinueOnError":false,"iDelayAfter":300,"iDelayBefore":200})
TracePrint($PrevResult)

Dim arrDivElements
arrDivElements = []
For Each value In arrElement
    a = value
    Dim sTag
    sTag = UiElement.GetAttribute(a, "tag", {"bContinueOnError":false,"iDelayAfter":300,"iDelayBefore":200})
    If LCase(sTag) = "div" 
        Push(arrDivElements, a)
        TracePrint(arrDivElements)
End If
Next

Rem 项目申报
Dim arr1
arr1 = [] 
For Each value In arrDivElements
a=value
TracePrint(a)
sRet = UiElement.GetAttribute(a,"aaname",{"bContinueOnError":false,"iDelayAfter":300,"iDelayBefore":200})
TracePrint(sRet)
If InStr(sRet,"项目申报",1,false) > 0 
TracePrint(sRet)
Push(arr1, sRet)
TracePrint(arr1)
End If
Next



Rem 在循环外部初始化Word文件数组
arrWordFiles = [] 
Dim fileCounter
fileCounter = 1

For Each value In arr1
b=value
TracePrint(value)
TracePrint(b)
Mouse.Action(@ui"块级元素<div>_通知公告“深入学习贯彻党的二十届四中全会精神”专栏征文启事为深入学习贯彻党的二十1","left","click",10000,{"bContinueOnError": false, "iDelayAfter": 300, "iDelayBefore": 200, "bSetForeground": true, "sCursorPosition": "Center", "iCursorOffsetX": 0, "iCursorOffsetY": 0, "sKeyModifiers": [],"sSimulate": "simulate", "bMoveSmoothly": false})
Rem 点击跳转成功

Rem 文件名 - 使用计数器确保文件名唯一
folderPath = "C:\\Users\\Administrator\\Desktop\\图书馆\\项目申报"

fileName = b & "_" & fileCounter
lastName=".docx"
wordname = folderPath & fileName& lastName

Rem 创建Word文档并设置格式
objWord = Word.Open(wordname,"","",True)
Word.SelectAll(objWord)
Word.Backspace(objWord)

Rem 获取文章标题
sRet = UiElement.GetAttribute(@ui"块级元素<div>_通知公告“深入学习贯彻党的二十届四中全会精神”专栏征文启事为深入学习贯彻党的二十2","aaname",{"bContinueOnError":false,"iDelayAfter":300,"iDelayBefore":200})

Rem 获取当前页面URL作为文章链接
Dim currentUrl

currentUrl = UiElement.GetValue(@ui"可编辑文本_https://www.bjsk.org.cn/newslist-1486-0-0.ht",{"bContinueOnError":false,"iDelayAfter":300,"iDelayBefore":200})
Rem 设置标题格式
Word.SetFontName(objWord,"黑体")
Word.SetFontSize(objWord,24)
Word.SetFontStyleEx(objWord,false,false,0)
Word.SetAlign(objWord,"center")
Word.Write(objWord,sRet)
Word.Enter(objWord)

Rem 获取文章正文内容
arrElement = UiElement.GetChildren(@ui"块级元素<div>_各相关市属单位：按照全国哲学社会科学工作办公室《2025年国家社科基金文化遗产保",1, {"bContinueOnError":false,"iDelayAfter":300,"iDelayBefore":200})
Keyboard.Press("Tab", "press", [],{"iDelayAfter": 300, "iDelayBefore": 200, "sSimulate": "simulate"})
TracePrint(arrElement)
Rem 遍历正文段落并写入Word
For i = 0 To len(arrElement) - 1 step 1
    正文i = i
    TracePrint(正文i)
    Rem 获取当前索引位置的段落元素
    currentElement = arrElement[i]
    sRet1 = UiElement.GetAttribute(currentElement,"innertext",{"bContinueOnError":false,"iDelayAfter":100,"iDelayBefore":100})
    style = UiElement.GetAttribute(currentElement,"style",{"bContinueOnError":false,"iDelayAfter":100,"iDelayBefore":100})
    TracePrint(sRet1)
    TracePrint(style)
    
    Rem 设置正文格式
    Word.SetFontName(objWord,"宋体")
    Word.SetFontSize(objWord,20)
    
    If i > 0
        Word.Enter(objWord)
    End If

    If InStr(sRet1, "文件下载：", 0, false) > 0 
        Rem 去除前面的空格
        sRet1 = Replace(sRet1, " 文件下载：", "文件下载：")
        Rem 设置为左对齐
        Word.SetAlign(objWord,"left")
    Else
        Rem 其他行保持原有对齐方式判断
        iRet = InStr(style,"text-align: right;",0,false)
        If iRet > 0 
            Word.Enter(objWord)
            Word.SetAlign(objWord,"right")
        Else 
            Word.SetAlign(objWord,"justify")
        End If
    End If


    Rem 从第二个正文开始（i>0），每段开头加两个空格
    If i > 0
        Word.Write(objWord,"  " & sRet1)  
    Else
        Word.Write(objWord,sRet1)    
    End If
Next

Rem 在文章最后添加链接
Word.Enter(objWord)
Word.SetFontName(objWord,"宋体")
Word.SetFontSize(objWord,16)
Word.SetFontStyleEx(objWord,false,false,0)
Word.SetAlign(objWord,"left")
Word.SetFontColor(objWord,"0000FF")
Word.SetFontStyleEx(objWord,false,false,1)
Word.Write(objWord,"文章链接：" & currentUrl)

Rem 保存文档
Word.SaveAs(objWord,wordname,{"fileFormat": 16})

Rem 在同一个文档对象中进行数字颜色设置
dRet = Word.ReadAll(objWord)

Rem 设置日期格式为红色
arr日期 = Regex.FindAll(dRet,"\\d{4}年\\d{1,2}月\\d{1,2}日")
For Each value In arr日期
    Word.SetTextPosition(objWord,value,0)
    Word.SetFontColor(objWord,"FF0000")
    TracePrint("设置日期颜色：" & value)
Next

Rem 设置月日格式为红色
arr月日 = Regex.FindAll(dRet,"\\d{1,2}月\\d{1,2}日")
For Each value In arr月日
    Word.SetTextPosition(objWord,value,0)
    Word.SetFontColor(objWord,"FF0000")
    TracePrint("设置月日颜色：" & value)
Next

Rem 设置邮箱格式为红色
arr邮箱 = Regex.FindAll(dRet,"邮箱[：:]?[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}")
TracePrint(arr邮箱)
For Each value In arr邮箱
    Word.SetTextPosition(objWord,value,0)
    Word.SetFontColor(objWord,"FF0000")
Next

Rem 重新保存文档并关闭
Word.SaveAs(objWord,wordname,{"fileFormat": 16})
Word.Close(objWord)

Rem 将Word文档路径添加到数组中
Push(arrWordFiles, wordname)
TracePrint("已添加文件：" & wordname & "，当前数组长度：" & len(arrWordFiles))

Rem 增加文件计数器
fileCounter = fileCounter + 1

Rem 继续跳转
Mouse.Action(@ui"链接<a>_首页","left","click",10000,{"bContinueOnError": false, "iDelayAfter": 300, "iDelayBefore": 200, "bSetForeground": true, "sCursorPosition": "Center", "iCursorOffsetX": 0, "iCursorOffsetY": 0, "sKeyModifiers": [],"sSimulate": "simulate", "bMoveSmoothly": false})

Mouse.Action(@ui"链接<a>_更多","left","click",10000,{"bContinueOnError": false, "iDelayAfter": 300, "iDelayBefore": 200, "bSetForeground": true, "sCursorPosition": "Center", "iCursorOffsetX": 0, "iCursorOffsetY": 0, "sKeyModifiers": [],"sSimulate": "simulate", "bMoveSmoothly": false})
Next

Rem 循环结束
App.Kill("msedge.exe")

Catch 异常
App.Kill("msedge.exe")
TracePrint(异常)
END Try
